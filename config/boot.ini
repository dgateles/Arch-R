odroidgoa-uboot-config

########################################################################
# Arch R Boot Configuration for R36S â€” Kernel 6.6 + Systemd
# PanCho panel selection is loaded by U-Boot before this script.
# If PanelNum is set, the corresponding panel DTBO overlay is applied.
# Default (no overlay): Panel 4-V22 (hardcoded in base DTB).
########################################################################

# Load PanCho if not already loaded by U-Boot
if ! env exist PanChoInitialized
then
    mw 0x01800000 0 0x2000
    if load mmc 1:1 0x01800000 PanCho.ini
    then
        source 0x01800000
    fi
fi

# Memory addresses
setenv dtbo_loadaddr    "0x01e00000"
setenv dtb_loadaddr     "0x01f00000"
setenv loadaddr         "0x02000000"

# Load kernel Image
if load mmc 1:1 ${loadaddr} Image
then
    # Calculate initrd address: kernel end + 16MB
    setexpr initrd_loadaddr ${loadaddr} + ${filesize}
    setexpr initrd_loadaddr ${initrd_loadaddr} + 0x01000000

    # Load DTB
    if load mmc 1:1 ${dtb_loadaddr} rk3326-gameconsole-r36s.dtb
    then
        # Apply panel DTBO overlay if PanCho set a panel
        # PanelPath is set by PanCho.ini (e.g. "ScreenFiles/Panel 4" or "ScreenFiles/Clone Panel 7")
        if env exist PanelPath
        then
            if load mmc 1:1 ${dtbo_loadaddr} "${PanelPath}/mipi-panel.dtbo"
            then
                fdt addr ${dtb_loadaddr}
                fdt resize 8192
                fdt apply ${dtbo_loadaddr}
                echo "Applied panel overlay: ${PanelPath}"
            fi
        fi

        # Pass panel info to userspace if set
        setenv panel_arg ""
        if env exist PanelNum
        then
            setenv panel_arg " panel=${PanelNum} PanelNum=${PanelNum}"
        fi

        # Try to load initrd, boot without if not found
        if load mmc 1:1 ${initrd_loadaddr} uInitrd
        then
            # With initrd: LABEL works (initrd resolves labels)
            # Silent boot: console=tty3 hides kernel messages, splash shown by systemd service
            setenv bootargs "root=LABEL=ROOTFS rootwait rw console=tty3 fbcon=rotate:0 loglevel=0 quiet systemd.show_status=false vt.global_cursor_default=0${panel_arg}"
            booti ${loadaddr} ${initrd_loadaddr} ${dtb_loadaddr}
        else
            # Without initrd: use device path directly (LABEL not resolved without initrd)
            # Silent boot: console=tty3 hides kernel messages, splash shown by systemd service
            setenv bootargs "root=/dev/mmcblk1p2 rootwait rw console=tty3 fbcon=rotate:0 loglevel=0 quiet systemd.show_status=false vt.global_cursor_default=0${panel_arg}"
            booti ${loadaddr} - ${dtb_loadaddr}
        fi
    fi
fi

# Power off if boot fails
sleep 15
poweroff
